
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Why my trained DPR is (was) not working</title>
    
  <link rel="stylesheet" href="../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="DPR Fine-Tuning (finally)" href="DPR_fine_tuning.html" />
    <link rel="prev" title="Visualisation de la précision dense vs sparse" href="Visualisation_results_Robin.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent">
 <span class="caption-text">
  Lab IA
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../lab_ia/intro.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../lab_ia/onboarding.html">
   Onboarding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../lab_ia/resources.html">
   Resources
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../../lab_ia/coding_standards.html">
   Coding Standards
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../../lab_ia/git.html">
     Working with Git
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../lab_ia/secrets.html">
     Secrets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../lab_ia/python.html">
     Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../lab_ia/jupyter.html">
     Notebooks (.ipynb)
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../lab_ia/reporting_standards.html">
   Reporting Standards
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Piaf - Pour une IA Francophone
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active collapsible-parent">
  <a class="reference internal" href="overview.html">
   Retriever Module
  </a>
  <ul class="current collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="complementarity_dense_sparse.html">
     Analyse complémentarité
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="complementarity_dense_sparse_v2.html">
     Analyse complémentarité
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="dense_vs_sparse_qualitative.html">
     Étude de scores systéme dense vs sparse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="score_threshold_sparse_retriever.html">
     Recherche d’un seuil pour le score sparse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Visualisation_csv_results.html">
     Visualisation de l’indice de précision obtenu dans results.csv
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Visualisation_results_Robin.html">
     Visualisation de la précision dense vs sparse
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Why my trained DPR is (was) not working
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="DPR_fine_tuning.html">
     DPR Fine-Tuning (finally)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ES_preprocessing.html">
     Test : Preprocessing directly with ElasticSearch Analyzers
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/piaf/retriever/DPR_performance.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/psorianom/knowledge-base"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/psorianom/knowledge-base/issues/new?title=Issue%20on%20page%20%2Fpiaf/retriever/DPR_performance.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/psorianom/knowledge-base/edit/master/docs/piaf/retriever/DPR_performance.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#intro">
   Intro
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem">
     Problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#possible-sources-of-errors">
     Possible sources of errors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#solutions-tested-already">
     Solutions tested already
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-with-haystack-s-evaluation-script">
   Performance with Haystack’s Evaluation Script
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-elasticsearchdocumentstore">
     Using
     <code class="docutils literal notranslate">
      <span class="pre">
       ElasticsearchDocumentStore
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bm25-default-results">
       BM25 Default Results
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dpr-facebook-results-embedded-title">
       DPR (facebook) Results (embedded title)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dpr-facebook-results-non-embedded-title">
       DPR (facebook) Results (non embedded title)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dpr-mbertdpr-results-embedded-title">
       DPR (
       <code class="docutils literal notranslate">
        <span class="pre">
         mbertDPR
        </span>
       </code>
       ) Results (embedded title)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dpr-mbertdpr-results-non-embedded-title">
       DPR (
       <code class="docutils literal notranslate">
        <span class="pre">
         mbertDPR
        </span>
       </code>
       ) Results (non embedded title)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dpr-mbert-results-embedded-title">
       DPR (
       <code class="docutils literal notranslate">
        <span class="pre">
         mbert
        </span>
       </code>
       ) Results (embedded title)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dpr-mbert-results-non-embedded-title">
       DPR (
       <code class="docutils literal notranslate">
        <span class="pre">
         mbert
        </span>
       </code>
       ) Results (non embedded title)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#discussion">
       Discussion
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-faiss">
     Using
     <code class="docutils literal notranslate">
      <span class="pre">
       FAISS
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-with-our-evaluation-script">
   Performance with our Evaluation Script
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#next-steps">
   Next Steps
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="why-my-trained-dpr-is-was-not-working">
<h1>Why my trained DPR is (was) not working<a class="headerlink" href="#why-my-trained-dpr-is-was-not-working" title="Permalink to this headline">¶</a></h1>
<div class="section" id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="Permalink to this headline">¶</a></h2>
<p>I have fine-tuned a camambert model over our combo of French SQuAD-like datasets (PIAF, FQuAD, SQuAD-FR) using the <a class="reference external" href="https://arxiv.org/abs/2004.04906">DPR objective</a> (similarity between query and positive and dissimilarity with negative contexts). The objective is to use this model in our PIAF Retriever module.</p>
<div class="section" id="problem">
<h3>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h3>
<p>The training has been completed on Jean ZAY. It runs without major problems apprently. Still, when testing this model with our <a class="reference external" href="https://github.com/etalab-ia/piaf-ml/blob/master/src/evaluation/retriever_25k_eval.py">evaluation script</a> and our test dataset (460 SPF questions), the results are surprisingly low (MAP around 5%) compared to those obtained with BM25 (~20%) and SBERT (~18%).</p>
</div>
<div class="section" id="possible-sources-of-errors">
<h3>Possible sources of errors<a class="headerlink" href="#possible-sources-of-errors" title="Permalink to this headline">¶</a></h3>
<p>One or more initial issues may be the culprit for this low performance:</p>
<ol class="simple">
<li><p>Not properly following the parameters used in DPR ;</p></li>
<li><p>DPR and Huggingface and Haystack are all ready for dealing with BERT-like encoders (context and query). Camembert is based on Roberta, so maybe the differences when converting the output of the DPR training to a Haystack compatible model input generate the low performance ;</p></li>
<li><p>The training (and dev) dataset has only one positive context and one hard negative context. While in the paper (and <a class="reference external" href="https://github.com/facebookresearch/DPR/issues/42">issues</a>) they affirm this is enough, and in the code it is indeed the case, maybe I am missing something ? Note: while the training uses only 1 hard negative contexts, the evaluation employs 30!</p></li>
<li><p>The hard negative contexts I am using are not good ? I follow the paper and use the top-k results from a BM25 query <strong>not containing the answer</strong> ;</p></li>
<li><p>My evaluation script des not work properly. The mapping + FAISS layer is somehow not working.</p></li>
</ol>
</div>
<div class="section" id="solutions-tested-already">
<h3>Solutions tested already<a class="headerlink" href="#solutions-tested-already" title="Permalink to this headline">¶</a></h3>
<p>For each problem above, I have tried:</p>
<ol class="simple">
<li><p>I was training with 4 Nvidia V100 GPUs, so a realb batch size of 16 * 4 = 64 ; while DPR used 8 V100s, so 16 * 8 = 128. Fixed this, no dice.</p></li>
<li><p>Changed to a <a class="reference external" href="https://huggingface.co/bert-base-multilingual-uncased">multilingual bert</a>. Still bad results, so even if use the same architecture, I still have bad results.</p></li>
<li><p>Following the original Natural Questions <a class="reference external" href="https://dl.fbaipublicfiles.com/dpr/data/retriever/biencoder-nq-train.json.gz">input datset used by DPR</a>, I added around 90 hard negative contexts to each question. The results with my script are still horrible.
<strong>Note</strong>: at the end of the training, we have an average rank of about 4, while DPR reported 24 :/</p></li>
<li><p>For problem 3, nothing tested yet.</p></li>
<li><p><strong>This notebook analyses</strong> the possibility of an ill-conceived evaluation script (specifically, the part testing dpr).</p></li>
</ol>
</div>
</div>
<div class="section" id="performance-with-haystack-s-evaluation-script">
<h2>Performance with Haystack’s Evaluation Script<a class="headerlink" href="#performance-with-haystack-s-evaluation-script" title="Permalink to this headline">¶</a></h2>
<p>I need to check if my fine-tuned multilingual Bert model (<code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code>) is working. Let’s not use my evaluation script, but <a class="reference external" href="https://github.com/deepset-ai/haystack/blob/master/tutorials/Tutorial5_Evaluation.ipynb">Haystack’s e2e evaluation script</a>. We will focus exlcusively on the retriever for now. Also, while they test in English, I believe a multilingual bert should not do very bad.</p>
<p>Haystack allows us to use either two types of backends: <code class="docutils literal notranslate"><span class="pre">ElasticsearchDocumentStore</span></code> or <code class="docutils literal notranslate"><span class="pre">FAISSDocumentStore</span></code>.
The former uses ElasticSearch, the latter uses Facebook FAISS.</p>
<p>Both backends are quite known and mature (ES much more maybe). In the following, I will test both backends in DPR mode, while using three models:</p>
<ol class="simple">
<li><p>the model as shared by DPR authors,</p></li>
<li><p>my <code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code> model, and</p></li>
<li><p>the non fine-tuned multilingual Bert model (<code class="docutils literal notranslate"><span class="pre">mbert</span></code>).</p></li>
</ol>
<div class="section" id="using-elasticsearchdocumentstore">
<h3>Using <code class="docutils literal notranslate"><span class="pre">ElasticsearchDocumentStore</span></code><a class="headerlink" href="#using-elasticsearchdocumentstore" title="Permalink to this headline">¶</a></h3>
<div class="section" id="bm25-default-results">
<h4>BM25 Default Results<a class="headerlink" href="#bm25-default-results" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.9367283950617283</span>
<span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">18</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">26</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">54</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">100.00</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>

</pre></div>
</div>
</div>
<div class="section" id="dpr-facebook-results-embedded-title">
<h4>DPR (facebook) Results (embedded title)<a class="headerlink" href="#dpr-facebook-results-embedded-title" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">18</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">09</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">54</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">100.00</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>
<span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.9711934156378601</span>
</pre></div>
</div>
</div>
<div class="section" id="dpr-facebook-results-non-embedded-title">
<h4>DPR (facebook) Results (non embedded title)<a class="headerlink" href="#dpr-facebook-results-non-embedded-title" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">18</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">17</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">53</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">98.15</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>
<span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">0.9814814814814815</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.955761316872428</span> 
</pre></div>
</div>
</div>
<div class="section" id="dpr-mbertdpr-results-embedded-title">
<h4>DPR (<code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code>) Results (embedded title)<a class="headerlink" href="#dpr-mbertdpr-results-embedded-title" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">19</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">12</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">54</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">100.00</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>
<span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.9223985890652557</span>
</pre></div>
</div>
</div>
<div class="section" id="dpr-mbertdpr-results-non-embedded-title">
<h4>DPR (<code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code>) Results (non embedded title)<a class="headerlink" href="#dpr-mbertdpr-results-non-embedded-title" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">19</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">48</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">54</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">100.00</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>
<span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.9259994121105234</span>
</pre></div>
</div>
</div>
<div class="section" id="dpr-mbert-results-embedded-title">
<h4>DPR (<code class="docutils literal notranslate"><span class="pre">mbert</span></code>) Results (embedded title)<a class="headerlink" href="#dpr-mbert-results-embedded-title" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">19</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">58</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">20</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">37.04</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>
<span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">0.37037037037037035</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.12617577895355675</span>
</pre></div>
</div>
</div>
<div class="section" id="dpr-mbert-results-non-embedded-title">
<h4>DPR (<code class="docutils literal notranslate"><span class="pre">mbert</span></code>) Results (non embedded title)<a class="headerlink" href="#dpr-mbert-results-non-embedded-title" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">19</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">42</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">haystack</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">base</span> <span class="o">-</span>   <span class="n">For</span> <span class="mi">18</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">54</span> <span class="n">questions</span> <span class="p">(</span><span class="mf">33.33</span><span class="o">%</span><span class="p">),</span> <span class="n">the</span> <span class="n">answer</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="mi">10</span> <span class="n">candidate</span> <span class="n">passages</span> <span class="n">selected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">retriever</span><span class="o">.</span>
<span class="n">Retriever</span> <span class="n">Recall</span><span class="p">:</span> <span class="mf">0.3333333333333333</span>
<span class="n">Retriever</span> <span class="n">Mean</span> <span class="n">Avg</span> <span class="n">Precision</span><span class="p">:</span> <span class="mf">0.12633009994121103</span>
</pre></div>
</div>
</div>
<div class="section" id="discussion">
<h4>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h4>
<p>In this proposed test, DPR from faceboook (MAP: 0.97) is indeed better than BM25 (MAP: 0.93).</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>And what is better ! Our <code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code> model is performing not as good as facebook’s DPR, but correctly (MAP: 0.92)! Maybe the model actually works and it is something else not working …</p>
</div>
<p>** This means there is an error in my evaluation script. ** Before moving on to find this bug, I decided to check the delta in performance between a FAISS and an ES backend.</p>
</div>
</div>
<div class="section" id="using-faiss">
<h3>Using <code class="docutils literal notranslate"><span class="pre">FAISS</span></code><a class="headerlink" href="#using-faiss" title="Permalink to this headline">¶</a></h3>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>Actually, I cannot test this using FAISS as a backend. The reason is that the method <code class="docutils literal notranslate"><span class="pre">add_eval_data</span></code> is not available for this document store.</p>
</div>
<p>We cannot test using Haystack evaluation script but we can test with our script (linked above). I took this evaluation (with FAISS as backend) as far as I could without wasting too much time. It works equally well (or bad) as with ElasticSearchDocumentStore. Some issues start popping up about the size of the column of a table used by FAISS (with postgres backup). It became too much of a hassle. Also, FAISS does not seem to deal with filters (theme, dossier, …).</p>
<p>Furthermore, I found this table below on the <a class="reference external" href="https://github.com/deepset-ai/haystack/blob/2531c8e0613f24b66838ab82ed02024d505aa578/test/benchmarks/retriever_query_results.csv">evaluation</a> carried on by Haystack and it shows that it is very much the same thing using FAISS or ES as backends.</p>
<div class="figure align-default" id="results-haystack">
<img alt="../../_images/haystack_ES_faiss_backend.png" src="../../_images/haystack_ES_faiss_backend.png" />
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Results reported by Haystack [here] (https://github.com/deepset-ai/haystack/blob/0a1e814bd99301dd186ea29de3d0e7619556a28a/test/benchmarks/retriever_query_results.csv)</span><a class="headerlink" href="#results-haystack" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="performance-with-our-evaluation-script">
<h2>Performance with our Evaluation Script<a class="headerlink" href="#performance-with-our-evaluation-script" title="Permalink to this headline">¶</a></h2>
<p>The main reason I was getting horrible results using FAISS is because I was running this line before indexing in FAISS :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">document_store</span><span class="o">.</span><span class="n">faiss_index</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</pre></div>
</div>
<p>Which I do not know what it does but it doesn’t do what I want: to clean the FAISS DB before indexing</p>
<p>Once this line was removed, I started getting decent results, which are reported in another report <span class="xref myst">overhere</span>.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>The objective of this experiment was to try and determine the source of error that caused the low performance of a fine-tuned DPR model on a French QA dataset. We found that the main culprit of this error was a bug in our evaluation script. I determined this error by using Haystack’s evaluation script and testing different DPR models.</p>
<p>The performance given by Facebook’s DPR model (MAP:0.97) is in the same ball-park than those found by the fine-tuned multilingual Bert model (MAP: 0.92) which would indicate that it works.</p>
<p>This result entails that my fine-tuning is actually working. It is important to note that <strong>this result is found with my <code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code> model trained with 90 hard negative examples per question</strong>.</p>
<p>A bug in the evaluation script was found and fixed, this allowed me to compute the results with our evaluation script. The results of the evaluation can be found in my next report <span class="xref myst">here</span>.</p>
<p>To recap, <strong>there was a bug in the analysis script</strong> and <strong>now we are using ~90 hard negative contexts</strong>. This way we get <strong>decent results with <code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code></strong>.</p>
<p>As a final remark, both <strong>FAISS or ES as backends seem to be the same performance-wise</strong> (with the amount of data we have).</p>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>We now know that the fine-tuned <code class="docutils literal notranslate"><span class="pre">mbertDPR</span></code> works. Thus, a fine tuned camemBERT should also work. This is covered in the next report (see <a class="reference internal" href="DPR_fine_tuning.html"><span class="doc">DPR Fine-Tuning (finally)</span></a>.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./piaf/retriever"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="Visualisation_results_Robin.html" title="previous page">Visualisation de la précision dense vs sparse</a>
    <a class='right-next' id="next-link" href="DPR_fine_tuning.html" title="next page">DPR Fine-Tuning (finally)</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By etalab-ia<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>